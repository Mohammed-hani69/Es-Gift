{% extends "admin/base.html" %}

{% block page_title %}تفاصيل طلب الإيداع #{{ request.id }}{% endblock %}

{% block extra_css %}
<style>
/* تنسيقات خاصة بصفحة التفاصيل */
.request-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
}

.detail-card h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--text-muted);
    font-weight: 500;
}

.detail-value {
    color: var(--text-color);
    font-weight: 600;
}

.amount-highlight {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary-color);
}

.actions-section {
    grid-column: 1 / -1;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 15px;
}

@media (max-width: 768px) {
    .request-details-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
}

/* تحسينات للأزرار المعطلة */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn:disabled .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* تنسيقات النماذج */
.form-section {
    margin-top: 20px;
}

.form-section .card {
    border: none;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.form-section .form-group {
    margin-bottom: 15px;
}

.form-section .form-label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

.form-section .form-control {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    width: 100%;
}

.form-section .form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.form-section .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.form-section .btn-success {
    background-color: #28a745;
    color: white;
}

.form-section .btn-danger {
    background-color: #dc3545;
    color: white;
}

.form-section .btn-secondary {
    background-color: #6c757d;
    color: white;
}

.form-section .btn:hover {
    opacity: 0.9;
}

/* CSS للمودالات */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--primary-color);
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    background: none;
    border: none;
}

.close:hover {
    color: #333;
}
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>
            <i class="fas fa-file-alt"></i>
            تفاصيل طلب الإيداع #{{ request.id }}
        </h2>
        <a href="{{ url_for('admin_wallet.deposit_requests') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i>
            العودة للقائمة
        </a>
    </div>
</div>

<div class="content-card">
    <div class="request-details-grid">
        <!-- معلومات المستخدم -->
        <div class="detail-card">
            <h3>
                <i class="fas fa-user"></i>
                معلومات المستخدم
            </h3>
            
            <div class="detail-item">
                <span class="detail-label">الاسم:</span>
                <span class="detail-value">{{ request.user.full_name or 'غير محدد' }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">البريد الإلكتروني:</span>
                <span class="detail-value">{{ request.user.email }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">نوع العضوية:</span>
                <span class="detail-value">
                    <span class="badge badge-{{ 'warning' if request.user_type == 'reseller' else 'info' if request.user_type == 'kyc' else 'secondary' }}">
                        {{ 'عادي' if request.user_type == 'regular' else 'موثق' if request.user_type == 'kyc' else 'موزع' if request.user_type == 'reseller' else 'عادي' }}
                    </span>
                </span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">عنوان IP:</span>
                <span class="detail-value">{{ request.user_ip or 'غير متوفر' }}</span>
            </div>
        </div>

        <!-- تفاصيل الطلب -->
        <div class="detail-card">
            <h3>
                <i class="fas fa-money-check-alt"></i>
                تفاصيل الطلب
            </h3>
            
            <div class="detail-item">
                <span class="detail-label">المبلغ:</span>
                <span class="detail-value amount-highlight">{{ request.amount }} {{ request.currency_code }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">المبلغ بالدولار:</span>
                <span class="detail-value">{{ request.amount_usd }} USD</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">سعر الصرف:</span>
                <span class="detail-value">{{ request.exchange_rate }}</span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">طريقة الدفع:</span>
                <span class="detail-value">
                    <i class="fas fa-credit-card"></i>
                    {% if request.payment_method == 'bank_transfer' %}
                        تحويل بنكي
                    {% elif request.payment_method == 'usdt_trc20' %}
                        USDT (TRC20)
                    {% else %}
                        {{ request.payment_method }}
                    {% endif %}
                </span>
            </div>
            
            <div class="detail-item">
                <span class="detail-label">الحالة:</span>
                <span class="detail-value">
                    <span class="badge badge-{{ 'warning' if request.status == 'pending' else 'success' if request.status == 'approved' else 'danger' }}">
                        <i class="fas fa-{{ 'clock' if request.status == 'pending' else 'check' if request.status == 'approved' else 'times' }}"></i>
                        {{ 'قيد المراجعة' if request.status == 'pending' else 'موافق' if request.status == 'approved' else 'مرفوض' }}
                    </span>
                </span>
            </div>
        </div>

        <!-- إثبات المعاملة -->
        {% if request.transaction_proof %}
        <div class="detail-card">
            <h3>
                <i class="fas fa-image"></i>
                إثبات المعاملة
            </h3>
            
            <div class="transaction-proof-section" style="text-align: center; padding: 20px;">
                <div class="proof-image-container" style="display: inline-block; max-width: 500px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 15px; background: rgba(255, 255, 255, 0.02);">
                    <img src="{{ url_for('static', filename='uploads/transaction_proofs/' + request.transaction_proof) }}" 
                         alt="إثبات المعاملة" 
                         style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);"
                         onclick="openImageModal(this.src)">
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                        <a href="{{ url_for('static', filename='uploads/transaction_proofs/' + request.transaction_proof) }}" 
                           target="_blank" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i>
                            فتح في نافذة جديدة
                        </a>
                        
                        <button onclick="downloadImage('{{ url_for('static', filename='uploads/transaction_proofs/' + request.transaction_proof) }}', '{{ request.transaction_proof }}')" 
                                class="btn btn-secondary btn-sm">
                            <i class="fas fa-download"></i>
                            تحميل
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- التواريخ والمعالجة -->
        <div class="detail-card">
            <h3>
                <i class="fas fa-history"></i>
                التواريخ والمعالجة
            </h3>
            
            <div class="detail-item">
                <span class="detail-label">تاريخ الطلب:</span>
                <span class="detail-value">{{ request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            
            {% if request.processed_at %}
            <div class="detail-item">
                <span class="detail-label">تاريخ المعالجة:</span>
                <span class="detail-value">{{ request.processed_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            {% endif %}
            
            {% if request.processor %}
            <div class="detail-item">
                <span class="detail-label">معالج الطلب:</span>
                <span class="detail-value">{{ request.processor.full_name or request.processor.email }}</span>
            </div>
            {% endif %}
            
            {% if request.wallet_amount_added %}
            <div class="detail-item">
                <span class="detail-label">المبلغ المضاف:</span>
                <span class="detail-value">{{ request.wallet_amount_added }} {{ request.wallet_currency_added }}</span>
            </div>
            {% endif %}
        </div>

        <!-- الملاحظات -->
        <div class="detail-card">
            <h3>
                <i class="fas fa-sticky-note"></i>
                الملاحظات
            </h3>
            
            {% if request.payment_details %}
            <div class="detail-item">
                <span class="detail-label">ملاحظات المستخدم:</span>
                <span class="detail-value">{{ request.payment_details }}</span>
            </div>
            {% endif %}
            
            {% if request.admin_notes %}
            <div class="detail-item">
                <span class="detail-label">ملاحظات الإدارة:</span>
                <span class="detail-value">{{ request.admin_notes }}</span>
            </div>
            {% endif %}
            
            {% if request.rejection_reason %}
            <div class="detail-item">
                <span class="detail-label">سبب الرفض:</span>
                <span class="detail-value" style="color: var(--danger-color);">{{ request.rejection_reason }}</span>
            </div>
            {% endif %}
            
            {% if not request.payment_details and not request.admin_notes and not request.rejection_reason %}
            <div class="detail-item">
                <span class="detail-value" style="color: var(--text-muted); font-style: italic;">لا توجد ملاحظات</span>
            </div>
            {% endif %}
        </div>

        <!-- الإجراءات -->
        {% if request.status == 'pending' %}
        <div class="actions-section">
            <h3>
                <i class="fas fa-cogs"></i>
                الإجراءات المتاحة
            </h3>
            
            <div class="action-buttons">
                <!-- نموذج الموافقة -->
                <form method="POST" action="{{ url_for('admin_wallet.approve_deposit', request_id=request.id) }}" style="display: inline-block;">
                    <button type="button" class="btn btn-success" onclick="showApproveForm(this)">
                        <i class="fas fa-check"></i>
                        موافقة على الطلب
                    </button>
                </form>
                
                <!-- نموذج الرفض -->
                <form method="POST" action="{{ url_for('admin_wallet.reject_deposit', request_id=request.id) }}" style="display: inline-block;" 
                      onsubmit="return confirm('هل أنت متأكد من رفض هذا الطلب؟')">
                    <input type="hidden" name="rejection_reason" value="تم رفض الطلب من قبل الإدارة">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i>
                        رفض الطلب
                    </button>
                </form>
                
                <!-- أزرار الفواتير متاحة للطلبات المعلقة أيضاً -->
                <div class="invoice-buttons" style="margin-top: 15px;">
                    {% if request.invoice_pdf_path %}
                    <a href="{{ url_for('admin_wallet.download_deposit_invoice', request_id=request.id) }}" 
                       class="btn btn-primary" target="_blank">
                        <i class="fas fa-download"></i>
                        تحميل فاتورة PDF
                    </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-info" onclick="generateInvoice()">
                        <i class="fas fa-file-pdf"></i>
                        {% if request.invoice_pdf_path %}إعادة إنشاء{% else %}إنشاء{% endif %} فاتورة PDF
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="actions-section">
            <h3>
                <i class="fas fa-info-circle"></i>
                حالة الطلب
            </h3>
            
            <div style="margin: 15px 0;">
                <p style="color: var(--text-muted);">
                    تم معالجة هذا الطلب بالفعل ولا يمكن تعديله.
                </p>
                
                <!-- أزرار الفواتير -->
                <div class="invoice-actions" style="margin-top: 20px;">
                    {% if request.invoice_pdf_path %}
                    <a href="{{ url_for('admin_wallet.download_deposit_invoice', request_id=request.id) }}" 
                       class="btn btn-primary" target="_blank">
                        <i class="fas fa-download"></i>
                        تحميل فاتورة PDF
                    </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-info" onclick="generateInvoice()">
                        <i class="fas fa-file-pdf"></i>
                        {% if request.invoice_pdf_path %}إعادة إنشاء{% else %}إنشاء{% endif %} فاتورة PDF
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- مودال الموافقة -->
<!-- نموذج الموافقة المخفي -->
<div id="approveFormSection" class="form-section" style="display: none;">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-check-circle"></i>
                موافقة على طلب الإيداع
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                سيتم إضافة المبلغ المحدد إلى محفظة المستخدم فوراً. تأكد من صحة المبلغ والعملة قبل المتابعة.
            </div>
            
            <form method="POST" action="{{ url_for('admin_wallet.approve_deposit', request_id=request.id) }}">
                <div class="form-group">
                    <label class="form-label">المبلغ المراد إضافته:</label>
                    <input type="number" name="amount" 
                           value="{{ request.amount }}" 
                           required min="0.01" step="0.01" 
                           placeholder="أدخل المبلغ" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label">العملة:</label>
                    <select name="currency" required class="form-control">
                        {% for currency in currencies %}
                        <option value="{{ currency.code }}" 
                                {{ 'selected' if currency.code == request.currency_code else '' }}>
                            {{ currency.symbol }} {{ currency.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ملاحظات الإدارة (اختياري):</label>
                    <textarea name="admin_notes" rows="3" 
                              placeholder="أي ملاحظات إضافية..." class="form-control"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideApproveForm()">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i>
                        تأكيد الموافقة
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
            </button>
        </div>
    </div>
</div>

<script>
// وظائف بسيطة لإظهار وإخفاء النماذج
function showApproveForm(button) {
    // إخفاء الأزرار
    button.closest('.action-buttons').style.display = 'none';
    // إظهار نموذج الموافقة
    document.getElementById('approveFormSection').style.display = 'block';
}

function hideApproveForm() {
    // إخفاء نموذج الموافقة
    document.getElementById('approveFormSection').style.display = 'none';
    // إظهار الأزرار مرة أخرى
    document.querySelector('.action-buttons').style.display = 'flex';
}

// إنشاء فاتورة PDF
function generateInvoice() {
    console.log('generateInvoice called');
    if (!confirm('هل تريد إنشاء فاتورة PDF لهذا الطلب؟')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...';
    button.disabled = true;
    
    fetch(`/admin/wallet/deposit-request/{{ request.id }}/generate-invoice`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم إنشاء فاتورة PDF بنجاح');
            // إعادة تحميل الصفحة لإظهار رابط التحميل
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            alert(data.message || 'فشل في إنشاء فاتورة PDF');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في إنشاء الفاتورة');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// عرض صورة إثبات المعاملة في مودال
function openImageModal(imageSrc) {
    // إنشاء مودال لعرض الصورة
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
    `;
    
    const img = document.createElement('img');
    img.src = imageSrc;
    img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
    `;
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 30px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 40px;
        cursor: pointer;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    modal.appendChild(img);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);
    
    // إغلاق المودال
    const closeModal = () => {
        document.body.removeChild(modal);
    };
    
    modal.onclick = closeModal;
    closeBtn.onclick = closeModal;
    
    // إغلاق بزر Escape
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

// تحميل الصورة
function downloadImage(imageSrc, filename) {
    const link = document.createElement('a');
    link.href = imageSrc;
    link.download = filename || 'transaction_proof.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

{% endblock %}
