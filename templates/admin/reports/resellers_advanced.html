{% extends "admin/base.html" %}

{% block page_title %}تقارير الموزعين المتقدمة{% endblock %}

{% block content %}
<div class="advanced-resellers-reports">
    <div class="page-header">
        <div class="header-content">
            <h1 style="color: #ff0033; margin-bottom: 10px;">
                <i class="fas fa-crown"></i>
                تحليلات الموزعين المتقدمة
            </h1>
            <p style="color: #ccc; margin-bottom: 20px;">
                تحليل شامل ومتقدم لأداء الموزعين مع إحصائيات تفصيلية وتنبؤات مستقبلية
            </p>
        </div>
        <div class="header-controls">
            <div class="period-selector">
                <select id="periodSelect" onchange="updatePeriod()">
                    <option value="today">اليوم</option>
                    <option value="week">أسبوع</option>
                    <option value="month" selected>شهر</option>
                    <option value="quarter">ربع سنة</option>
                    <option value="year">سنة</option>
                    <option value="custom">فترة مخصصة</option>
                </select>
            </div>
            <div id="customDates" class="custom-dates" style="display: none;">
                <input type="date" id="startDate" placeholder="من تاريخ">
                <input type="date" id="endDate" placeholder="إلى تاريخ">
                <button onclick="applyCustomDates()" class="btn btn-primary">تطبيق</button>
            </div>
            <div class="export-options">
                <button class="btn btn-success" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="btn btn-danger" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <!-- البطاقات الإحصائية الرئيسية -->
    <div class="main-stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalResellers">{{ stats.total_resellers or 0 }}</div>
                <div class="stat-label">إجمالي الموزعين</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span id="resellersGrowth">+{{ ((stats.total_resellers or 0) * 0.12) | round(1) }}%</span>
                </div>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="activeResellers">{{ stats.active_resellers or 0 }}</div>
                <div class="stat-label">الموزعين النشطين</div>
                <div class="stat-sublabel">في هذه الفترة</div>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ "{:,.0f}".format(stats.total_revenue or 0) }} ر.س</div>
                <div class="stat-label">إجمالي الإيرادات</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+15.3%</span>
                </div>
            </div>
        </div>

        <div class="stat-card danger">
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ "{:,.0f}".format(stats.total_profit or 0) }} ر.س</div>
                <div class="stat-label">صافي الأرباح</div>
                <div class="stat-sublabel">هامش: {{ "{:.1f}".format(stats.profit_margin or 0) }}%</div>
            </div>
        </div>

        <div class="stat-card info">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.total_orders or 0 }}</div>
                <div class="stat-label">إجمالي الطلبات</div>
                <div class="stat-sublabel">{{ stats.completed_orders or 0 }} مكتمل</div>
            </div>
        </div>

        <div class="stat-card secondary">
            <div class="stat-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ "{:,.0f}".format(stats.avg_order_value or 0) }} ر.س</div>
                <div class="stat-label">متوسط قيمة الطلب</div>
                <div class="stat-change neutral">
                    <i class="fas fa-equals"></i>
                    <span>0.5%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- الرسوم البيانية المتقدمة -->
    <div class="advanced-charts-section">
        <div class="charts-row">
            <!-- رسم الاتجاهات -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-area"></i> تحليل الاتجاهات والتنبؤات</h3>
                    <div class="chart-controls">
                        <select id="trendMetric" onchange="updateTrendChart()">
                            <option value="revenue">الإيرادات</option>
                            <option value="orders">عدد الطلبات</option>
                            <option value="profit">الأرباح</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <!-- توزيع الموزعين -->
            <div class="chart-card">
                <h3><i class="fas fa-pie-chart"></i> توزيع الموزعين حسب الأداء</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="resellersDistributionChart"></canvas>
                </div>
            </div>

            <!-- أداء المنتجات -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-bar"></i> أداء المنتجات الرائجة</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="productsPerformanceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <!-- خريطة حرارية للمبيعات -->
            <div class="chart-card">
                <h3><i class="fas fa-calendar-alt"></i> خريطة حرارية للمبيعات</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="salesHeatmapChart"></canvas>
                </div>
            </div>

            <!-- تحليل الربحية -->
            <div class="chart-card">
                <h3><i class="fas fa-percentage"></i> تحليل هوامش الربح</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="profitMarginChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- تحليلات متقدمة -->
    <div class="advanced-analytics">
        <div class="analytics-tabs">
            <button class="tab-btn active" onclick="showAnalyticsTab('performance')">
                <i class="fas fa-rocket"></i> تحليل الأداء
            </button>
            <button class="tab-btn" onclick="showAnalyticsTab('behavior')">
                <i class="fas fa-brain"></i> تحليل السلوك
            </button>
            <button class="tab-btn" onclick="showAnalyticsTab('predictions')">
                <i class="fas fa-crystal-ball"></i> التنبؤات
            </button>
            <button class="tab-btn" onclick="showAnalyticsTab('comparison')">
                <i class="fas fa-balance-scale"></i> المقارنات
            </button>
        </div>

        <!-- تبويب تحليل الأداء -->
        <div id="performance-tab" class="analytics-tab-content active">
            <div class="performance-grid">
                <div class="performance-card">
                    <h4><i class="fas fa-star"></i> أفضل الموزعين</h4>
                    <div class="top-performers">
                        {% for reseller in stats.top_resellers[:5] %}
                        <div class="performer-item">
                            <div class="performer-info">
                                <strong>{{ reseller.full_name or reseller.email }}</strong>
                                <small>{{ reseller.total_orders }} طلب</small>
                            </div>
                            <div class="performer-value">
                                {{ "{:,.0f}".format(reseller.total_spent) }} ر.س
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="performance-card">
                    <h4><i class="fas fa-trophy"></i> المنتجات الأكثر ربحية</h4>
                    <div class="profit-products">
                        {% for product in stats.top_products[:5] %}
                        <div class="product-profit-item">
                            <div class="product-info">
                                <strong>{{ product.name }}</strong>
                                <small>{{ product.total_sold }} مبيع</small>
                            </div>
                            <div class="profit-value">
                                {{ "{:,.0f}".format(product.total_revenue) }} ر.س
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="performance-card">
                    <h4><i class="fas fa-clock"></i> أوقات الذروة</h4>
                    <div class="peak-times">
                        <div class="time-slot">
                            <span class="time">10:00 - 12:00</span>
                            <div class="activity-bar" style="width: 85%"></div>
                            <span class="percentage">85%</span>
                        </div>
                        <div class="time-slot">
                            <span class="time">14:00 - 16:00</span>
                            <div class="activity-bar" style="width: 70%"></div>
                            <span class="percentage">70%</span>
                        </div>
                        <div class="time-slot">
                            <span class="time">20:00 - 22:00</span>
                            <div class="activity-bar" style="width: 60%"></div>
                            <span class="percentage">60%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- تبويب تحليل السلوك -->
        <div id="behavior-tab" class="analytics-tab-content">
            <div class="behavior-analysis">
                <div class="behavior-metric">
                    <h4>متوسط عدد الطلبات لكل موزع</h4>
                    <div class="metric-value">{{ "{:.1f}".format((stats.total_orders or 0) / (stats.active_resellers or 1)) }}</div>
                </div>
                <div class="behavior-metric">
                    <h4>متوسط قيمة الطلب الشهرية</h4>
                    <div class="metric-value">{{ "{:,.0f}".format(stats.avg_order_value or 0) }} ر.س</div>
                </div>
                <div class="behavior-metric">
                    <h4>معدل إعادة الشراء</h4>
                    <div class="metric-value">78.5%</div>
                </div>
            </div>
        </div>

        <!-- تبويب التنبؤات -->
        <div id="predictions-tab" class="analytics-tab-content">
            <div class="predictions-grid">
                <div class="prediction-card">
                    <h4><i class="fas fa-arrow-trend-up"></i> نمو الإيرادات المتوقع</h4>
                    <div class="prediction-value positive">+18.5%</div>
                    <p>خلال الثلاثة أشهر القادمة</p>
                </div>
                <div class="prediction-card">
                    <h4><i class="fas fa-users-plus"></i> موزعين جدد متوقعين</h4>
                    <div class="prediction-value">{{ ((stats.total_resellers or 0) * 0.15) | round(0) | int }}</div>
                    <p>في الشهر القادم</p>
                </div>
                <div class="prediction-card">
                    <h4><i class="fas fa-shopping-bag"></i> الطلبات المتوقعة</h4>
                    <div class="prediction-value">{{ ((stats.total_orders or 0) * 1.25) | round(0) | int }}</div>
                    <p>الشهر القادم</p>
                </div>
            </div>
        </div>

        <!-- تبويب المقارنات -->
        <div id="comparison-tab" class="analytics-tab-content">
            <div class="comparison-chart">
                <h4>مقارنة الأداء - آخر 6 أشهر</h4>
                <canvas id="comparisonChart" style="height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- جدول تفصيلي متقدم -->
    <div class="advanced-table-section">
        <div class="table-header">
            <h3><i class="fas fa-table"></i> تفاصيل الموزعين المتقدمة</h3>
            <div class="table-controls">
                <input type="text" id="searchTable" placeholder="البحث..." onkeyup="filterTable()">
                <select id="sortBy" onchange="sortTable()">
                    <option value="revenue">ترتيب حسب الإيرادات</option>
                    <option value="orders">ترتيب حسب الطلبات</option>
                    <option value="profit">ترتيب حسب الأرباح</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <table class="advanced-data-table" id="resellersTable">
                <thead>
                    <tr>
                        <th>الموزع</th>
                        <th>عدد الطلبات</th>
                        <th>إجمالي المبيعات</th>
                        <th>الأرباح المحققة</th>
                        <th>هامش الربح</th>
                        <th>متوسط الطلب</th>
                        <th>آخر نشاط</th>
                        <th>التقييم</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reseller in stats.top_resellers %}
                    <tr>
                        <td>
                            <div class="reseller-info">
                                <div class="reseller-avatar">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="reseller-details">
                                    <strong>{{ reseller.full_name or 'غير محدد' }}</strong>
                                    <small>{{ reseller.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="orders-count">{{ reseller.total_orders }}</span>
                        </td>
                        <td>
                            <span class="revenue-amount">{{ "{:,.0f}".format(reseller.total_spent) }} ر.س</span>
                        </td>
                        <td>
                            <span class="profit-amount">{{ "{:,.0f}".format(reseller.total_spent * 0.15) }} ر.س</span>
                        </td>
                        <td>
                            <span class="profit-margin">15.0%</span>
                        </td>
                        <td>
                            <span class="avg-order">{{ "{:,.0f}".format(reseller.total_spent / reseller.total_orders) }} ر.س</span>
                        </td>
                        <td>
                            <span class="last-activity">اليوم</span>
                        </td>
                        <td>
                            <div class="rating">
                                {% for i in range(5) %}
                                <i class="fas fa-star {{ 'active' if i < 4 else '' }}"></i>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action" onclick="viewResellerDetails({{ reseller.id if reseller.id else 1 }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action" onclick="contactReseller({{ reseller.id if reseller.id else 1 }})">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- إحصائيات إضافية -->
    <div class="additional-stats">
        <div class="stats-row">
            <div class="stat-widget">
                <h4><i class="fas fa-calendar-week"></i> إحصائيات أسبوعية</h4>
                <div class="weekly-chart">
                    <canvas id="weeklyChart" style="height: 200px;"></canvas>
                </div>
            </div>
            <div class="stat-widget">
                <h4><i class="fas fa-map-marked-alt"></i> توزيع جغرافي</h4>
                <div class="geographic-stats">
                    <div class="geo-item">
                        <span class="region">الرياض</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 45%"></div>
                        </div>
                        <span class="percentage">45%</span>
                    </div>
                    <div class="geo-item">
                        <span class="region">جدة</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 30%"></div>
                        </div>
                        <span class="percentage">30%</span>
                    </div>
                    <div class="geo-item">
                        <span class="region">الدمام</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 15%"></div>
                        </div>
                        <span class="percentage">15%</span>
                    </div>
                    <div class="geo-item">
                        <span class="region">أخرى</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 10%"></div>
                        </div>
                        <span class="percentage">10%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.advanced-resellers-reports {
    padding: 20px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    min-height: 100vh;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.header-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.period-selector select {
    padding: 10px 15px;
    background: #333;
    border: 1px solid #555;
    border-radius: 8px;
    color: #fff;
    font-weight: 500;
}

.custom-dates {
    display: flex;
    gap: 10px;
    align-items: center;
}

.custom-dates input {
    padding: 10px;
    background: #333;
    border: 1px solid #555;
    border-radius: 5px;
    color: #fff;
}

.export-options {
    display: flex;
    gap: 10px;
}

.main-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff0033, #ff6600);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
}

.stat-card.primary::before { background: linear-gradient(90deg, #007bff, #0056b3); }
.stat-card.success::before { background: linear-gradient(90deg, #28a745, #20c997); }
.stat-card.warning::before { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.stat-card.danger::before { background: linear-gradient(90deg, #dc3545, #c82333); }
.stat-card.info::before { background: linear-gradient(90deg, #17a2b8, #138496); }
.stat-card.secondary::before { background: linear-gradient(90deg, #6c757d, #5a6268); }

.stat-card {
    display: flex;
    align-items: center;
    gap: 20px;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.stat-label {
    color: #ccc;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.stat-sublabel {
    color: #999;
    font-size: 0.8rem;
}

.stat-change {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    margin-top: 8px;
}

.stat-change.positive { color: #28a745; }
.stat-change.negative { color: #dc3545; }
.stat-change.neutral { color: #ffc107; }

.advanced-charts-section {
    margin-bottom: 40px;
}

.charts-row {
    display: grid;
    gap: 25px;
    margin-bottom: 25px;
}

.charts-row .chart-card.full-width {
    grid-column: 1 / -1;
}

.charts-row:not(:has(.full-width)) {
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
}

.chart-card {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-header h3 {
    color: #fff;
    margin: 0;
    font-size: 1.2rem;
}

.chart-controls select {
    padding: 8px 12px;
    background: #333;
    border: 1px solid #555;
    border-radius: 5px;
    color: #fff;
}

.chart-container {
    position: relative;
}

.advanced-analytics {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.analytics-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 1px solid #444;
}

.tab-btn {
    padding: 12px 20px;
    background: transparent;
    border: none;
    color: #ccc;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover,
.tab-btn.active {
    background: #ff0033;
    color: #fff;
}

.analytics-tab-content {
    display: none;
}

.analytics-tab-content.active {
    display: block;
}

.performance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
}

.performance-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.performance-card h4 {
    color: #fff;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.performer-item,
.product-profit-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.performer-item:last-child,
.product-profit-item:last-child {
    border-bottom: none;
}

.performer-info,
.product-info {
    display: flex;
    flex-direction: column;
}

.performer-info strong,
.product-info strong {
    color: #fff;
    margin-bottom: 3px;
}

.performer-info small,
.product-info small {
    color: #ccc;
    font-size: 0.85rem;
}

.performer-value,
.profit-value {
    color: #ff0033;
    font-weight: bold;
}

.time-slot {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.time-slot .time {
    width: 100px;
    color: #ccc;
    font-size: 0.9rem;
}

.activity-bar {
    flex: 1;
    height: 8px;
    background: #ff0033;
    border-radius: 4px;
    position: relative;
}

.percentage {
    color: #fff;
    font-weight: bold;
    font-size: 0.9rem;
}

.behavior-analysis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.behavior-metric {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.behavior-metric h4 {
    color: #ccc;
    margin-bottom: 15px;
    font-size: 1rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #ff0033;
}

.predictions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.prediction-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.prediction-card h4 {
    color: #ccc;
    margin-bottom: 15px;
    font-size: 1rem;
}

.prediction-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.prediction-value.positive {
    color: #28a745;
}

.prediction-card p {
    color: #999;
    margin: 0;
}

.advanced-table-section {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.table-header h3 {
    color: #fff;
    margin: 0;
}

.table-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.table-controls input,
.table-controls select {
    padding: 8px 12px;
    background: #333;
    border: 1px solid #555;
    border-radius: 5px;
    color: #fff;
}

.table-container {
    overflow-x: auto;
}

.advanced-data-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    overflow: hidden;
}

.advanced-data-table th {
    background: #ff0033;
    color: #fff;
    padding: 15px;
    text-align: right;
    font-weight: 600;
}

.advanced-data-table td {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
}

.advanced-data-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

.reseller-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.reseller-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #ff0033;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

.reseller-details {
    display: flex;
    flex-direction: column;
}

.reseller-details strong {
    margin-bottom: 3px;
}

.reseller-details small {
    color: #ccc;
    font-size: 0.85rem;
}

.orders-count,
.revenue-amount,
.profit-amount,
.profit-margin,
.avg-order {
    font-weight: 600;
}

.profit-margin {
    color: #28a745;
}

.last-activity {
    color: #17a2b8;
}

.rating {
    display: flex;
    gap: 2px;
}

.rating .fa-star {
    color: #555;
    font-size: 0.9rem;
}

.rating .fa-star.active {
    color: #ffc107;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    width: 35px;
    height: 35px;
    border: none;
    border-radius: 50%;
    background: #ff0033;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: #cc0029;
    transform: scale(1.1);
}

.additional-stats {
    margin-bottom: 40px;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
}

.stat-widget {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-widget h4 {
    color: #fff;
    margin-bottom: 20px;
    font-size: 1.1rem;
}

.geographic-stats {
    space-y: 15px;
}

.geo-item {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.geo-item .region {
    width: 80px;
    color: #ccc;
    font-size: 0.9rem;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: linear-gradient(90deg, #ff0033, #ff6600);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.geo-item .percentage {
    color: #fff;
    font-weight: bold;
    font-size: 0.9rem;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: #007bff;
    color: #fff;
}

.btn-success {
    background: #28a745;
    color: #fff;
}

.btn-danger {
    background: #dc3545;
    color: #fff;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

@media (max-width: 768px) {
    .main-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-row {
        grid-template-columns: 1fr;
    }
    
    .performance-grid {
        grid-template-columns: 1fr;
    }
    
    .behavior-analysis {
        grid-template-columns: 1fr;
    }
    
    .predictions-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .table-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-controls {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// بيانات التقارير
const statsData = {{ stats | tojsonfilter | safe }};

// تحديث الفترة الزمنية
function updatePeriod() {
    const select = document.getElementById('periodSelect');
    const customDates = document.getElementById('customDates');
    
    if (select.value === 'custom') {
        customDates.style.display = 'flex';
    } else {
        customDates.style.display = 'none';
        // إعادة تحميل البيانات للفترة الجديدة
        window.location.href = `?period=${select.value}`;
    }
}

// تطبيق التواريخ المخصصة
function applyCustomDates() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        window.location.href = `?period=custom&start_date=${startDate}&end_date=${endDate}`;
    } else {
        alert('يرجى اختيار تاريخ البداية والنهاية');
    }
}

// تصدير التقرير
function exportReport(format) {
    const period = new URLSearchParams(window.location.search).get('period') || 'month';
    const startDate = new URLSearchParams(window.location.search).get('start_date') || '';
    const endDate = new URLSearchParams(window.location.search).get('end_date') || '';
    
    const url = `/admin/reports/export/resellers?format=${format}&period=${period}&start_date=${startDate}&end_date=${endDate}`;
    window.open(url, '_blank');
}

// عرض تبويبات التحليلات
function showAnalyticsTab(tabName) {
    // إخفاء جميع التبويبات
    document.querySelectorAll('.analytics-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // إزالة الفئة النشطة من جميع الأزرار
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // عرض التبويب المحدد
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // إضافة الفئة النشطة للزر المحدد
    event.target.classList.add('active');
}

// تحديث رسم الاتجاهات
function updateTrendChart() {
    // منطق تحديث الرسم البياني
    console.log('تحديث رسم الاتجاهات');
}

// فلترة الجدول
function filterTable() {
    const searchTerm = document.getElementById('searchTable').value.toLowerCase();
    const table = document.getElementById('resellersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// ترتيب الجدول
function sortTable() {
    // منطق ترتيب الجدول
    console.log('ترتيب الجدول');
}

// عرض تفاصيل الموزع
function viewResellerDetails(resellerId) {
    alert(`عرض تفاصيل الموزع رقم: ${resellerId}`);
}

// التواصل مع الموزع
function contactReseller(resellerId) {
    alert(`التواصل مع الموزع رقم: ${resellerId}`);
}

// تهيئة الرسوم البيانية
function initializeCharts() {
    createTrendChart();
    createResellersDistributionChart();
    createProductsPerformanceChart();
    createSalesHeatmapChart();
    createProfitMarginChart();
    createComparisonChart();
    createWeeklyChart();
}

// رسم الاتجاهات
function createTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    const monthlyData = statsData.monthly_sales || [];
    const labels = monthlyData.map(item => {
        const date = new Date(item.year, item.month - 1);
        return date.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' });
    });
    
    const revenueData = monthlyData.map(item => item.revenue);
    const trendData = revenueData.map((value, index) => {
        // حساب الاتجاه المتوقع
        const trend = index > 0 ? value * 1.1 : value;
        return trend;
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'الإيرادات الفعلية',
                data: revenueData,
                borderColor: '#ff0033',
                backgroundColor: 'rgba(255, 0, 51, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }, {
                label: 'الاتجاه المتوقع',
                data: trendData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#fff' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#ccc',
                        callback: function(value) {
                            return value.toLocaleString() + ' ر.س';
                        }
                    },
                    grid: { color: '#333' }
                },
                x: {
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                }
            }
        }
    });
}

// رسم توزيع الموزعين
function createResellersDistributionChart() {
    const ctx = document.getElementById('resellersDistributionChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ممتاز', 'جيد جداً', 'جيد', 'مقبول', 'ضعيف'],
            datasets: [{
                data: [25, 35, 20, 15, 5],
                backgroundColor: [
                    '#28a745',
                    '#17a2b8',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#fff' }
                }
            }
        }
    });
}

// رسم أداء المنتجات
function createProductsPerformanceChart() {
    const ctx = document.getElementById('productsPerformanceChart').getContext('2d');
    
    const topProducts = statsData.top_products || [];
    const labels = topProducts.slice(0, 5).map(item => item.name);
    const data = topProducts.slice(0, 5).map(item => item.total_sold);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'المبيعات',
                data: data,
                backgroundColor: '#ff0033',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#fff' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                },
                x: {
                    ticks: { 
                        color: '#ccc',
                        maxRotation: 45
                    },
                    grid: { color: '#333' }
                }
            }
        }
    });
}

// خريطة حرارية للمبيعات
function createSalesHeatmapChart() {
    const ctx = document.getElementById('salesHeatmapChart').getContext('2d');
    
    // بيانات وهمية للخريطة الحرارية
    const days = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
    const hours = ['00', '06', '12', '18'];
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'صباحاً',
                data: [20, 25, 30, 35, 32, 28, 15],
                backgroundColor: 'rgba(255, 0, 51, 0.6)'
            }, {
                label: 'ظهراً',
                data: [30, 35, 40, 45, 42, 38, 25],
                backgroundColor: 'rgba(255, 0, 51, 0.8)'
            }, {
                label: 'مساءً',
                data: [25, 30, 35, 40, 38, 35, 20],
                backgroundColor: 'rgba(255, 0, 51, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#fff' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                },
                x: {
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                }
            }
        }
    });
}

// رسم هوامش الربح
function createProfitMarginChart() {
    const ctx = document.getElementById('profitMarginChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
            datasets: [{
                label: 'هامش الربح %',
                data: [12, 14, 15, 13, 16, 18],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#fff' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#ccc',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: { color: '#333' }
                },
                x: {
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                }
            }
        }
    });
}

// رسم المقارنة
function createComparisonChart() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['الإيرادات', 'الطلبات', 'الأرباح', 'رضا العملاء', 'النمو'],
            datasets: [{
                label: 'الأداء الحالي',
                data: [85, 78, 82, 90, 75],
                borderColor: '#ff0033',
                backgroundColor: 'rgba(255, 0, 51, 0.2)',
                borderWidth: 2
            }, {
                label: 'الهدف',
                data: [90, 85, 88, 95, 80],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#fff' }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' },
                    pointLabels: { color: '#fff' }
                }
            }
        }
    });
}

// رسم أسبوعي
function createWeeklyChart() {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'],
            datasets: [{
                label: 'المبيعات اليومية',
                data: [120, 150, 180, 200, 190, 160, 100],
                backgroundColor: '#ff0033',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                },
                x: {
                    ticks: { color: '#ccc' },
                    grid: { color: '#333' }
                }
            }
        }
    });
}

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});
</script>
{% endblock %}
