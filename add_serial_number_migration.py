#!/usr/bin/env python3
"""
Migration script Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ serial_number Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ ProductCode
ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« models.py
"""

import sqlite3
import os
from datetime import datetime

def add_serial_number_column():
    """Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ serial_number Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ product_code"""
    
    # Ù…Ø³Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db_path = os.path.join('instance', 'es_gift.db')
    
    if not os.path.exists(db_path):
        print("âŒ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
        return False
    
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        backup_path = f"{db_path}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ
        import shutil
        shutil.copy2(db_path, backup_path)
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")
        
        # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯
        cursor.execute("PRAGMA table_info(product_code)")
        columns = [column[1] for column in cursor.fetchall()]
        
        if 'serial_number' in columns:
            print("âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ serial_number Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
            conn.close()
            return True
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        cursor.execute("""
            ALTER TABLE product_code 
            ADD COLUMN serial_number VARCHAR(200)
        """)
        
        conn.commit()
        conn.close()
        
        print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ serial_number Ø¨Ù†Ø¬Ø§Ø­")
        return True
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯: {str(e)}")
        return False

if __name__ == "__main__":
    print("ğŸ”„ Ø¨Ø¯Ø¡ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ serial_number...")
    
    if add_serial_number_column():
        print("ğŸ‰ ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!")
        print("ğŸ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡")
    else:
        print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø©")
        print("ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©")
