#!/usr/bin/env python3
"""
ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ KYC Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
"""

import sqlite3
import os
from datetime import datetime

def upgrade_database():
    """ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ KYC Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"""
    
    db_path = os.path.join('instance', 'es_gift.db')
    
    if not os.path.exists(db_path):
        print("âŒ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
        return False
    
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        backup_path = f"{db_path}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        with open(db_path, 'rb') as src, open(backup_path, 'wb') as dst:
            dst.write(src.read())
        
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")
        
        # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        cursor.execute("PRAGMA table_info(user)")
        existing_columns = [column[1] for column in cursor.fetchall()]
        print(f"Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: {existing_columns}")
        
        # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¶Ø§ÙØªÙ‡Ø§
        new_columns = [
            ('document_type', 'VARCHAR(50)'),
            ('passport_image', 'VARCHAR(200)'),
            ('driver_license_image', 'VARCHAR(200)'),
            ('face_photo_front', 'VARCHAR(200)'),
            ('face_photo_right', 'VARCHAR(200)'),
            ('face_photo_left', 'VARCHAR(200)')
        ]
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        added_columns = []
        for column_name, column_type in new_columns:
            if column_name not in existing_columns:
                try:
                    cursor.execute(f"ALTER TABLE user ADD COLUMN {column_name} {column_type}")
                    added_columns.append(column_name)
                    print(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„: {column_name}")
                except sqlite3.Error as e:
                    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ {column_name}: {e}")
            else:
                print(f"âš ï¸  Ø§Ù„Ø­Ù‚Ù„ {column_name} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
        
        # Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        conn.commit()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        cursor.execute("PRAGMA table_info(user)")
        final_columns = [column[1] for column in cursor.fetchall()]
        print(f"\nØ§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {final_columns}")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ù„ÙØ§Øª
        upload_dirs = [
            'static/uploads/kyc-documents',
            'static/uploads/face-verification'
        ]
        
        for upload_dir in upload_dirs:
            os.makedirs(upload_dir, exist_ok=True)
            print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯: {upload_dir}")
        
        conn.close()
        
        if added_columns:
            print(f"\nğŸ‰ ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
            print(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© {len(added_columns)} Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯: {', '.join(added_columns)}")
        else:
            print("\nâœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ø¨Ø§Ù„ÙØ¹Ù„ - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ±Ù‚ÙŠØ©")
        
        return True
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        return False

if __name__ == '__main__':
    print("ğŸ”„ Ø¨Ø¯Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    success = upgrade_database()
    
    if success:
        print("\nâœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!")
        print("ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… KYC Ø§Ù„Ù…Ø­Ø¯Ø«")
    else:
        print("\nâŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ±Ù‚ÙŠØ©!")
