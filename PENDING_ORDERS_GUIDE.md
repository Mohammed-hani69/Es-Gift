# نظام الطلبات المعلقة - دليل الاستخدام

## نظرة عامة

تم تطوير نظام جديد لمعالجة الطلبات التي لا تحتوي على أكواد منتجات متوفرة. بدلاً من فشل العملية، يقوم النظام بإنشاء الطلب في حالة "معلق" ويسمح للإدارة بإضافة الأكواد لاحقاً.

## ميزات النظام

### 1. معالجة ذكية للطلبات
- **الحالة الأولى**: إذا كانت جميع الأكواد متوفرة → إرسال البريد فوراً
- **الحالة الثانية**: إذا كانت بعض الأكواد متوفرة → حالة `partial_codes`
- **الحالة الثالثة**: إذا لم تكن أي أكواد متوفرة → حالة `pending_codes`

### 2. واجهة إدارية شاملة
- عرض جميع الطلبات المعلقة
- إضافة أكواد للطلبات
- إعادة إرسال البريد الإلكتروني
- تتبع حالة الطلبات

### 3. إشعارات تلقائية
- إشعار الإدارة عند وجود طلبات معلقة
- رسائل بريد إلكتروني للمتابعة

## حالات الطلبات

| الحالة | الوصف | الإجراء المطلوب |
|--------|-------|-----------------|
| `completed` | تم إرسال جميع الأكواد | لا يوجد |
| `partial_codes` | تم إرسال بعض الأكواد | إضافة الأكواد المتبقية |
| `pending_codes` | لم يتم إرسال أي أكواد | إضافة جميع الأكواد |
| `failed` | فشل في المعالجة | مراجعة يدوية |

## استخدام واجهة الإدارة

### الوصول للطلبات المعلقة
```
/admin/pending-orders
```

### إضافة أكواد للطلب
1. اختر الطلب من القائمة
2. انقر على "إدارة الأكواد"
3. أدخل الأكواد المطلوبة
4. احفظ التغييرات

### إعادة إرسال البريد
1. تأكد من إضافة جميع الأكواد
2. انقر على "إعادة إرسال البريد"
3. سيتم إرسال ملف Excel بالأكواد

## الملفات المحدثة

### 1. routes.py
- دالة `process_payment`: معالجة ذكية للأكواد
- تخصيص أكواد جزئي أو كامل
- إشعارات تلقائية للإدارة

### 2. admin_routes.py
- `/admin/pending-orders`: عرض الطلبات المعلقة
- `/admin/add-codes-to-order`: إضافة أكواد
- `/admin/resend-order-email`: إعادة إرسال البريد
- `/admin/order-json`: API للطلبات

### 3. brevo_integration.py
- `send_admin_notification`: إشعار الإدارة
- دعم كامل لجميع أنواع البريد

### 4. templates/admin/pending_orders.html
- واجهة شاملة لإدارة الطلبات
- نماذج إضافة الأكواد
- عرض تفاصيل الطلبات

## اختبار النظام

```bash
python test_pending_orders.py
```

## إعداد البريد الإلكتروني

تأكد من إعداد Brevo بشكل صحيح:
```python
# في brevo_config.py
BREVO_API_KEY = "your-api-key"
```

## استكشاف الأخطاء

### مشكلة: لا يتم إرسال الإشعارات
**الحل**: 
1. تأكد من إعداد Brevo
2. تحقق من إيميلات الإدارة في `send_admin_notification`

### مشكلة: لا تظهر الطلبات المعلقة
**الحل**:
1. تأكد من وجود طلبات بحالة `pending_codes`
2. تحقق من قاعدة البيانات

### مشكلة: فشل في إرسال البريد
**الحل**:
1. تحقق من ملف Excel
2. تأكد من وجود جميع الأكواد
3. مراجعة إعدادات Brevo

## دعم المطورين

للمساعدة أو الاستفسارات:
- راجع ملفات التوثيق
- اختبر النظام باستخدام `test_pending_orders.py`
- تحقق من ملفات السجل

---

**ملاحظة**: هذا النظام يضمن عدم فقدان أي طلب حتى لو لم تكن الأكواد متوفرة وقت الشراء.
